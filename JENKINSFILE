pipeline {
    agent any

    options { skipDefaultCheckout() }

    stages {

        stage('Get Code') {
            steps {
                git 'https://github.com/jlcesardev/cp2.git'
                echo "WORKSPACE: ${env.WORKSPACE}"
                bat 'dir'
            }
        }

        stage('Unit Tests') {
            agent { label 'agent1' }
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    bat '''
                    echo === LIMPIANDO CACHE PYTHON ===
                    for /d /r . %%d in (__pycache__) do @if exist "%%d" rd /s /q "%%d"
                    del /s /q *.pyc 2>nul

                    set PYTHONPATH=%WORKSPACE%
                    rmdir /S /Q test_old 2>nul
                    python -B -m coverage run --branch --source=app --omit=app\\__init__.py,app\\api.py -m pytest test\\unit
                    '''
                    junit 'result-unit.xml'
                }
            }
        }

       
        stage('Performance') {
            steps {
                bat '''
                set FLASK_APP=app\\api.py
                start /B flask run
                ping -n 4 127.0.0.1
                C:\\unir\\apache-jmeter-5.6.3\\bin\\jmeter -n -t test\\jmeter\\flask.jmx -l flask.jtl
                '''
                perfReport sourceDataFiles: 'flask.jtl'
            }
        }
        
        stage('Coverage') {
    steps {
        bat '''
        echo === COVERAGE SOLO app.util ===
        python -B -m coverage erase
        python -B -m coverage run --branch --source=app.util -m pytest test\\unit
        python -B -m coverage report -m
        python -B -m coverage xml
        '''
        publishCoverage adapters: [coberturaAdapter('coverage.xml')]
    }
}


       
    }
}
